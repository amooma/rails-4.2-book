Bundler and Gems
================

Gems
----

Gems constitute the package management in the world of Ruby. If a Ruby
developer wants to offer a specific feature or a certain program or collection
of programs to other Ruby developers, he can create a "gem" from these. This
gem can then be installed via `gem install`. How to create a gem and where it
can be hosted goes beyond the scope of this introduction chapter. The
important thing for our purposes is that for example Rails in itself is also
available as gem.

Bundler
-------

In a Rails project, different gems are used (see [Section "Gems"](#gems)) and
a developer can also add further gems. Bundler helps the developer to install
all these gems in the right version and to take into account important
dependencies. In previous Rails versions, you as developer had to always call
a `bundle install` after a `rails new`. Now, this is done automatically within
`rails new`. In the output you can see which gems are installed by `bundle
install`:

```bash
$ rails new webshop
[...]
     run  bundle install
Fetching gem metadata from https://rubygems.org/..........
Fetching version metadata from https://rubygems.org/..
Resolving dependencies...
Using rake 10.4.2
Using i18n 0.7.0
Using json 1.8.2
Using minitest 5.6.1
Using thread_safe 0.3.5
Using tzinfo 1.2.2
Using activesupport 4.2.1
[...]
Using sqlite3 1.3.10
Using turbolinks 2.5.3
Using uglifier 2.7.1
Using web-console 2.1.2
Bundle complete! 12 Gemfile dependencies, 54 gems now installed.
Use `bundle show [gemname]` to see where a bundled gem is installed.
         run  bundle exec spring binstub --all
* bin/rake: spring inserted
* bin/rails: spring inserted
```

The file `Gemfile` generated by `rails
    new` indicates which gems are to be installed by Bundler:

```ruby
source 'https://rubygems.org'


# Bundle edge Rails instead: gem 'rails', github: 'rails/rails'
gem 'rails', '4.2.1'
# Use sqlite3 as the database for Active Record
gem 'sqlite3'
# Use SCSS for stylesheets
gem 'sass-rails', '~> 5.0'
# Use Uglifier as compressor for JavaScript assets
gem 'uglifier', '>= 1.3.0'
# Use CoffeeScript for .coffee assets and views
gem 'coffee-rails', '~> 4.1.0'
# See https://github.com/rails/execjs#readme for more supported runtimes
# gem 'therubyracer', platforms: :ruby

# Use jquery as the JavaScript library
gem 'jquery-rails'
# Turbolinks makes following links in your web application faster. Read more:
# https://github.com/rails/turbolinks
gem 'turbolinks'
# Build JSON APIs with ease. Read more: https://github.com/rails/jbuilder
gem 'jbuilder', '~> 2.0'
# bundle exec rake doc:rails generates the API under doc/api.
gem 'sdoc', '~> 0.4.0', group: :doc

# Use ActiveModel has_secure_password
# gem 'bcrypt', '~> 3.1.7'

# Use Unicorn as the app server
# gem 'unicorn'

# Use Capistrano for deployment
# gem 'capistrano-rails', group: :development

group :development, :test do
  # Call 'byebug' anywhere in the code to stop execution and get a debugger
  # console
  gem 'byebug'

  # Access an IRB console on exception pages or by using <%= console %> in
  # views
  gem 'web-console', '~> 2.0'

  # Spring speeds up development by keeping your application running in the
  # background. Read more: https://github.com/rails/spring
  gem 'spring'
end
```

The format used is easy to explain: the word `gem` is followed by the
name of the gem and then, if required, a specification of the version of
the gem.

For example, the line `gem 'rails', '4.2.1'` stands for "install the gem
with the name `rails` in the version 4.2.1".

With `~>` before the version number you can determine that the newest version
after this version number should be installed. As a result, the last digit is
incremented, so for example `gem 'rails', '~> 4.0.0'` would correspondingly
install a Rails 4.0.1, but not a 4.1 (for the latter, you would need to
specify `gem 'rails', '~> 4.1'`).

> **Important**
>
> You have the option of installing certain gems only in certain environments.
> To do so, you need to enclose the corresponding lines in a `group :name do`
> loop.

Apart from the file `Gemfile` there is also the file `Gemfile.lock` and the
exact versions of the installed gems are listed there. In the above example,
it looks like this:

```ruby
GEM
  remote: https://rubygems.org/
  specs:
    actionmailer (4.2.1)
      actionpack (= 4.2.1)
      actionview (= 4.2.1)
      activejob (= 4.2.1)
      mail (~> 2.5, >= 2.5.4)
      rails-dom-testing (~> 1.0, >= 1.0.5)
    actionpack (4.2.1)
      actionview (= 4.2.1)
      activesupport (= 4.2.1)
      rack (~> 1.6)
      rack-test (~> 0.6.2)
      rails-dom-testing (~> 1.0, >= 1.0.5)
      rails-html-sanitizer (~> 1.0, >= 1.0.1)
    actionview (4.2.1)
      activesupport (= 4.2.1)
      builder (~> 3.1)
      erubis (~> 2.7.0)
      rails-dom-testing (~> 1.0, >= 1.0.5)
      rails-html-sanitizer (~> 1.0, >= 1.0.1)
      [...]

PLATFORMS
  ruby

DEPENDENCIES
  byebug
  coffee-rails (~> 4.1.0)
  jbuilder (~> 2.0)
  jquery-rails
  rails (= 4.2.1)
  sass-rails (~> 5.0)
  sdoc (~> 0.4.0)
  spring
  sqlite3
  turbolinks
  uglifier (>= 1.3.0)
  web-console (~> 2.0)
```

The advantage of `Gemfile.lock` is that it makes it possible for several
developers to work on the same Rails project independently from one another
and to still be sure that they are all working with the same gem versions. If
a file is `Gemfile.lock`, this will be used by the Bundler.  This is also
useful for deploying the Rails project later on a web server.

Thanks to this mechanism you can use and develop several Rails projects with
different gem version numbers in parallel.

### bundle update

With `bundle update` you can update gems to new versions. As an example,
I have a Rails project with the Rails version 4.2.1:

```bash
$ rails -v
Rails 4.2.1
$
```

In the file `Gemfile`, this version is listed:

```bash
$ head -n 5 Gemfile
source 'https://rubygems.org'


# Bundle edge Rails instead: gem 'rails', github: 'rails/rails'
gem 'rails', '4.2.1'
```

And also in the `Gemfile.lock`:

```bash
$ grep 'rails' Gemfile.lock
      rails-dom-testing (~> 1.0, >= 1.0.5)
      rails-dom-testing (~> 1.0, >= 1.0.5)
      rails-html-sanitizer (~> 1.0, >= 1.0.1)
      rails-dom-testing (~> 1.0, >= 1.0.5)
      rails-html-sanitizer (~> 1.0, >= 1.0.1)
    coffee-rails (4.1.0)
    jquery-rails (4.0.3)
      rails-dom-testing (~> 1.0)
    rails (4.2.1)
      sprockets-rails
    rails-deprecated_sanitizer (1.0.3)
    rails-dom-testing (1.0.6)
      rails-deprecated_sanitizer (>= 1.0.1)
    rails-html-sanitizer (1.0.2)
    sass-rails (5.0.3)
      sprockets-rails (>= 2.0, < 4.0)
    sprockets-rails (2.2.4)
      coffee-rails
      sprockets-rails (>= 2.0, < 4.0)
  coffee-rails (~> 4.1.0)
  jquery-rails
  rails (= 4.2.1)
  sass-rails (~> 5.0)
$
```

Assumed we are working with rails 4.2.0 and we want to update to 
rails 4.2.1. Then we have to change the `Gemfile` from this:

```ruby
[...]
# Bundle edge Rails instead: gem 'rails', github: 'rails/rails'
gem 'rails', '4.2.0'
[...]
```

to this:

```ruby
[...]
# Bundle edge Rails instead: gem 'rails', github: 'rails/rails'
gem 'rails', '4.2.1'
[...]
```

After this change, you can use `bundle update rails` to install the new Rails
version (required dependencies are automatically taken into account by
Bundler):

```bash
$ bundle update rails
  [...]
$ rails -v
Rails 4.2.1
$
```

> **Important**
>
> After every gem update, you should first run `rake test` to make sure that a
> new gem version does not add any unwanted side effects.

### bundle outdated

If you want to know which of the gems used by your Rails project are now
available in a new version, you can do this via the command `bundle outdated`.
Example:

```bash
$ bundle outdated
Fetching gem metadata from https://rubygems.org/..........
Fetching version metadata from https://rubygems.org/..
Resolving dependencies...

Outdated gems included in the bundle:
  * tilt (2.0.1 > 1.4.1)
```

### bundle exec

`bundle exec` is probably one of the commands Rails developers hate the most.
It is required whenever a program such as `rake` is used in a Rails project
and is present in a different version than the rest of the system. The
resulting error message is always easy to implement:

```bash
You have already activated rake 0.10, but your Gemfile requires rake 0.9.2.2.
Using bundle exec may solve this.
```

In this case, it helps to invoke the command with a preceding
`bundle exec`:

```bash
$ bundle exec rake db:migrate
```

#### binstubs

In some environments, using `bundle exec` is too complicated. In that case,
you can install programs with the correct version via `bundle install
--binstubs` in the directory bin:

```bash
$ bundle install --binstubs
Using rake 10.4.2
Using i18n 0.7.0
Using json 1.8.2
Using minitest 5.6.1
Using thread_safe 0.3.5
Using tzinfo 1.2.2
Using activesupport 4.2.1
Using builder 3.2.2
[...]
Using turbolinks 2.5.3
Using uglifier 2.7.1
Using web-console 2.1.2
Bundle complete! 12 Gemfile dependencies, 54 gems now installed.
Use `bundle show [gemname]` to see where a bundled gem is installed.
```

Afterwards, you can always use these programs. Example:

```bash
$ bin/rake db:migrate
==  CreateUsers: migrating ====================================================
-- create_table(:users)
   -> 0.0018s
==  CreateUsers: migrated (0.0019s) ===========================================

$
```

### Further Information on Bundler

The topic Bundler is far more complex than can be described here. If you
want to find out more on Bundler, please visit the following websites to
find further information:

-   <http://railscasts.com/episodes/201-bundler-revised>

-   <http://gembundler.com/>
